{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}صفحه اصلی | رستوران{% endblock %}

{% block preloader %}
{# ----- Preloader: نمایش بارگذاری سایت ----- #}
<div class="preloader d-flex align-items-center justify-content-center">
    <div class="preloader-content">
        <h3>در حال بارگزاری..</h3>
        <div id="cooking">
            {# حباب‌های انیمیشنی #}
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>
            <div class="bubble"></div>

            {# انیمیشن تابه و پنکیک #}
            <div id="area">
                <div id="sides">
                    <div id="pan"></div>
                    <div id="handle"></div>
                </div>
                <div id="pancake">
                    <div id="pastry"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block header %}
{# ----- Header Area: شامل لوگو، منو و سوشال مدیا ----- #}
{% include 'header.html' %}
{% endblock %}

{% block content %}
{# ----- Hero Section ----- #}
{% include 'hero.html' %}

{# ----- محصولات موجود در فروشگاه ----- #}
<div class="container section-padding-100">
    <h2 class="mb-4">همه محصولات</h2>
    {% if products %}
    <div class="row">
        {% for product in products %}
        {# ----- کارت محصول ----- #}
        <div class="col-12 col-sm-6 col-lg-4 mb-4">
            <div class="card h-100">
                {# تصویر محصول #}
                <img src="{{ product.image.url|default:'/static/images/default-product.jpg' }}" 
                     class="card-img-top" alt="{{ product.name }}">
                <div class="card-body">
                    {# نام محصول #}
                    <h5 class="card-title">{{ product.name }}</h5>
                    {# توضیح محصول #}
                    <p class="card-text">{{ product.description }}</p>
                    {# قیمت محصول با فرمت مناسب #}
                    <p class="card-text">قیمت: {{ product.price|floatformat:2|intcomma }} تومان</p>

                    {# انتخاب تعداد محصول #}
                    <div class="input-group mb-3">
                        <button class="btn btn-outline-secondary" type="button"
                            onclick="updateQuantity('{{ product.slug }}', -1)">-</button>
                        <input type="number" class="form-control text-center" 
                               id="quantity-{{ product.slug }}" value="1" min="1">
                        <button class="btn btn-outline-secondary" type="button"
                            onclick="updateQuantity('{{ product.slug }}', 1)">+</button>
                    </div>

                    {# دکمه افزودن به سبد خرید #}
                    <button class="btn bueno-btn w-100" 
                            onclick="addToCart('{{ product.slug }}')">افزودن به سبد خرید</button>
                </div>
            </div>
        </div>
        {% empty %}
        {# پیغام در صورت عدم وجود محصول #}
        <p class="text-center">هیچ محصولی یافت نشد.</p>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-center">هیچ محصولی موجود نیست.</p>
    {% endif %}
</div>

{# ----- جاوااسکریپت مدیریت تعداد و سبد خرید ----- #}
<script>
    // تغییر تعداد محصول
    function updateQuantity(productSlug, change) {
        let input = document.getElementById('quantity-' + productSlug);
        let currentValue = parseInt(input.value);
        if (currentValue + change >= 1) {
            input.value = currentValue + change;
        }
    }

    // افزودن محصول به سبد خرید
    function addToCart(productSlug) {
        let quantity = document.getElementById('quantity-' + productSlug).value;
        fetch('{% url "add_to_cart" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                product_slug: productSlug,
                quantity: quantity
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('محصول به سبد خرید اضافه شد!');
                location.reload();

                // بروزرسانی تعداد سبد خرید به صورت داینامیک
                fetch('{% url "cart_item_count" %}')
                .then(response => response.json())
                .then(data => {
                    const cartCount = document.querySelector('.cart-count');
                    if (data.cart_item_count > 0) {
                        cartCount.textContent = data.cart_item_count;
                        cartCount.style.display = 'inline-flex';
                    } else {
                        cartCount.style.display = 'none';
                    }
                });
            } else {
                alert('خطایی رخ داد: ' + data.message);
            }
        });
    }
</script>

{# ----- بخش محصولات پرطرفدار / Trending Section ----- #}
{% include 'trending.html' %}
{% endblock %}

{% block footer %}
{# ----- Footer Area ----- #}
{% include 'footer.html' %}
{% endblock %}
